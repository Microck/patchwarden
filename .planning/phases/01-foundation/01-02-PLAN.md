---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .env.example
  - src/jarspect/storage/__init__.py
  - src/jarspect/storage/base.py
  - src/jarspect/storage/local.py
  - src/jarspect/storage/azure_blob.py
  - src/jarspect/api/routes/upload.py
  - src/jarspect/api/main.py
  - tests/test_upload.py
autonomous: true

must_haves:
  truths:
    - "User can upload a .jar file via API"
    - "Uploaded file is persisted using a storage backend"
  artifacts:
    - path: "src/jarspect/api/routes/upload.py"
      provides: "Upload endpoint"
    - path: "src/jarspect/storage/base.py"
      provides: "Storage backend interface"
  key_links:
    - from: "src/jarspect/api/routes/upload.py"
      to: "src/jarspect/storage/base.py"
      via: "StorageBackend.save_bytes"
      pattern: "save_"
---

<objective>
Implement the file upload endpoint and storage abstraction with a local fallback (default) and an Azure Blob adapter (optional).

Purpose: Establish the upload pipeline required for Intake + later agent analysis.
Output: POST /upload endpoint + storage backends + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@/home/ubuntu/workspace/ai-dev-days-hackathon/plans/jarspect.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Storage interface + local implementation (default)</name>
  <files>
.env.example
src/jarspect/storage/__init__.py
src/jarspect/storage/base.py
src/jarspect/storage/local.py
  </files>
  <action>
Create a small storage abstraction with the minimum operations needed for upload + retrieval:
- `save_bytes(key: str, content_type: str | None, data: bytes) -> StoredObject`
- `get_bytes(key: str) -> bytes`
- `get_url(key: str) -> str | None` (for Azure; local can return None)

Implement `LocalStorage` storing objects under a configurable directory (default: `.local-data/uploads`).
Ensure the implementation prevents path traversal (keys must be normalized / validated).

Add `.env.example` with placeholders for:
- `STORAGE_BACKEND=local|azure_blob` (default local)
- `LOCAL_STORAGE_DIR=.local-data/uploads`

Do not require Azure credentials for local mode.
  </action>
  <verify>python3 -c "from jarspect.storage.local import LocalStorage; LocalStorage('.local-data/uploads')"</verify>
  <done>Local storage backend can save and read bytes in a temp directory.</done>
</task>

<task type="auto">
  <name>Task 2: Azure Blob storage adapter (optional, env-gated)</name>
  <files>
src/jarspect/storage/azure_blob.py
  </files>
  <action>
Implement `AzureBlobStorage` in `src/jarspect/storage/azure_blob.py` behind env gating:
- If required env vars are missing, raise a clear error at instantiation time.

Expected env vars to support (document in `.env.example`):
- `AZURE_STORAGE_CONNECTION_STRING`
- `AZURE_STORAGE_CONTAINER`

Keep the rest of the codebase depending only on the storage interface; no Azure imports should be required when using local mode.
  </action>
  <verify>python3 -c "import jarspect.storage.azure_blob as m; print('imported')"</verify>
  <done>Azure adapter module imports without breaking local mode (it may error only when instantiated without env).</done>
</task>

<task type="auto">
  <name>Task 3: Upload API route + tests</name>
  <files>
src/jarspect/api/routes/upload.py
src/jarspect/api/main.py
tests/test_upload.py
  </files>
  <action>
Add `POST /upload` accepting multipart file field `file`.

Behavior:
- Reject non-`.jar` filenames with 400.
- Enforce a configurable max size (default safe limit, e.g. 50MB) with 413.
- Generate an `upload_id` (uuid) and store the file with key like `uploads/{upload_id}.jar`.
- Return JSON: `{upload_id, filename, size_bytes, storage_url?}`.

Wire the router into `src/jarspect/api/main.py`.

Tests:
- Upload a small synthetic jar (can be any bytes with .jar name) and assert 200 + `upload_id`.
- Upload with wrong extension and assert 400.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Upload endpoint persists bytes via local storage and tests pass.</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- `curl -F "file=@some.jar" localhost:8000/upload` returns JSON with `upload_id`
</verification>

<success_criteria>
- Upload works end-to-end in local mode with no Azure configuration
- Azure Blob adapter exists and is selectable by env var (but not required)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
