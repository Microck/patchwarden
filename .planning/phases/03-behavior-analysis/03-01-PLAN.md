---
phase: 03-behavior-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jarspect/llm/__init__.py
  - src/jarspect/llm/client.py
  - src/jarspect/llm/prompts.py
  - src/jarspect/models/behavior.py
  - src/jarspect/agents/behavior_agent.py
  - tests/test_behavior_agent_stub.py
autonomous: true

must_haves:
  truths:
    - "Behavior Agent produces a structured behavior prediction"
    - "Project runs with a deterministic stub LLM in local dev"
  artifacts:
    - path: "src/jarspect/agents/behavior_agent.py"
      provides: "Behavior Agent"
    - path: "src/jarspect/llm/client.py"
      provides: "LLM client abstraction"
  key_links:
    - from: "src/jarspect/agents/behavior_agent.py"
      to: "src/jarspect/llm/client.py"
      via: "LLMClient.complete_json"
      pattern: "LLMClient"
---

<objective>
Add the Behavior Agent with an LLM client abstraction and a deterministic local stub.

Purpose: Enable behavior prediction without requiring cloud credentials for local development.
Output: Behavior agent + models + tests using stubbed LLM.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-static-analysis/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: LLM client abstraction with env-gated real provider + local stub</name>
  <files>
src/jarspect/llm/__init__.py
src/jarspect/llm/client.py
src/jarspect/llm/prompts.py
  </files>
  <action>
Create an `LLMClient` abstraction that supports:
- `complete_json(system_prompt: str, user_prompt: str) -> dict`

Implement:
- `StubLLMClient` used by default in local dev that returns deterministic JSON (no network).
- `FoundryLLMClient` (or similarly named) that is only constructed when required env vars exist.

Do not hardcode provider-specific assumptions in the agent logic; keep them in `llm/client.py`.
  </action>
  <verify>python3 -c "from jarspect.llm.client import StubLLMClient; print(StubLLMClient().complete_json('s','u'))"</verify>
  <done>Stub LLM returns deterministic JSON suitable for tests.</done>
</task>

<task type="auto">
  <name>Task 2: Behavior models + Behavior Agent using structured output</name>
  <files>
src/jarspect/models/behavior.py
src/jarspect/agents/behavior_agent.py
tests/test_behavior_agent_stub.py
  </files>
  <action>
Define `BehaviorPrediction` model that captures:
- predicted file reads/writes (paths as strings, may be "unknown")
- predicted network activity (domains/urls/ports)
- predicted persistence/startup behavior (bool + rationale)
- overall behavior risk summary + confidence

Implement `BehaviorAgent` that:
- accepts static findings + (optionally) selected decompiled text snippets
- builds a prompt (in `llm/prompts.py`) that requests a STRICT JSON object matching the model
- uses `LLMClient.complete_json` and validates/parses into `BehaviorPrediction`

Tests should use `StubLLMClient` to assert deterministic parsing and model validation.
  </action>
  <verify>python3 -m pytest -q -k behavior_agent_stub --maxfail=1</verify>
  <done>BehaviorAgent returns a validated `BehaviorPrediction` using the stub client.</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- No network calls are required for local test execution
</verification>

<success_criteria>
- Behavior Agent exists and returns structured predictions even in stubbed mode
</success_criteria>

<output>
After completion, create `.planning/phases/03-behavior-analysis/03-01-SUMMARY.md`
</output>
