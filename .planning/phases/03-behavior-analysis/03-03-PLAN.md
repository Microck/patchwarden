---
phase: 03-behavior-analysis
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/jarspect/models/scan.py
  - src/jarspect/api/routes/scan.py
  - src/jarspect/pipeline/snippet_select.py
  - tests/test_scan_behavior.py
autonomous: true

must_haves:
  truths:
    - "Scan endpoint returns behavior predictions alongside static findings"
    - "Prompt input size is bounded by selecting only relevant snippets"
  artifacts:
    - path: "src/jarspect/pipeline/snippet_select.py"
      provides: "Snippet selection for prompts"
  key_links:
    - from: "src/jarspect/api/routes/scan.py"
      to: "src/jarspect/agents/behavior_agent.py"
      via: "behavior agent invocation"
      pattern: "BehaviorAgent"
---

<objective>
Integrate Behavior Agent into the scan route and ensure prompts stay within a bounded size by selecting relevant code snippets.

Purpose: Provide believable behavior predictions for the demo flow.
Output: Extended scan response (intake + static + behavior) + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-static-analysis/02-04-SUMMARY.md
@.planning/phases/03-behavior-analysis/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snippet selection to bound prompt size</name>
  <files>src/jarspect/pipeline/snippet_select.py</files>
  <action>
Implement a helper that selects a small set of representative code snippets for the Behavior Agent prompt.

Strategy:
- Prioritize files with the highest severity static matches
- Include at most N files (e.g., 3) and at most M chars per snippet (e.g., 2000)
- Always include evidence excerpts for top matches

This is to keep LLM prompts stable and fast.
  </action>
  <verify>python3 -c "from jarspect.pipeline.snippet_select import select_snippets; print('ok')"</verify>
  <done>Snippet selection helper exists and enforces strict size limits.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Behavior Agent into /scan and extend ScanResult model</name>
  <files>
src/jarspect/models/scan.py
src/jarspect/api/routes/scan.py
tests/test_scan_behavior.py
  </files>
  <action>
Extend the scan flow to:
- run intake
- run static
- select snippets
- run behavior agent
- return `{intake, static, behavior}`

Tests should:
- Use the stub LLM to ensure `/scan` returns a `behavior` object with expected fields.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Scan endpoint includes behavior predictions and tests pass using stub LLM.</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- Upload -> scan returns intake + static + behavior
</verification>

<success_criteria>
- Phase 3 completes with behavior predictions in the API response
</success_criteria>

<output>
After completion, create `.planning/phases/03-behavior-analysis/03-03-SUMMARY.md`
</output>
