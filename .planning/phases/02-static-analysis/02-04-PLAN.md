---
phase: 02-static-analysis
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - src/jarspect/agents/static_agent.py
  - src/jarspect/models/scan.py
  - src/jarspect/api/routes/scan.py
  - tests/test_scan_static.py
autonomous: true

must_haves:
  truths:
    - "Scan endpoint returns static findings for an uploaded jar"
    - "Static findings include pattern matches and signature matches"
  artifacts:
    - path: "src/jarspect/agents/static_agent.py"
      provides: "Static Agent implementation"
    - path: "src/jarspect/api/routes/scan.py"
      provides: "Scan endpoint extended with static results"
  key_links:
    - from: "src/jarspect/agents/static_agent.py"
      to: "src/jarspect/analysis/static_scan.py"
      via: "pattern matching"
      pattern: "static_scan"
---

<objective>
Implement Static Agent and integrate it into the scan pipeline so uploads produce deterministic static findings.

Purpose: Provide clear suspicious indicators prior to behavior prediction.
Output: Static agent + scan response schema updates + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Static Agent implementation</name>
  <files>src/jarspect/agents/static_agent.py</files>
  <action>
Implement `StaticAgent` that takes an `upload_id` (or intake result) and returns `StaticFindings`.

Process:
- fetch upload bytes
- enumerate classes
- decompile classes (CFR if configured, else fallback)
- run pattern matcher
- run signature store search over decompiled text (and/or disassembly text)

Do not execute any mod code.
  </action>
  <verify>python3 -c "from jarspect.agents.static_agent import StaticAgent; print('ok')"</verify>
  <done>StaticAgent can be instantiated and exposes a single analysis method with clear return type.</done>
</task>

<task type="auto">
  <name>Task 2: Extend scan response schema and route to include static findings</name>
  <files>
src/jarspect/models/scan.py
src/jarspect/api/routes/scan.py
tests/test_scan_static.py
  </files>
  <action>
Add/extend a `ScanResult` model that includes:
- `intake`
- `static` (static findings)

Update `POST /scan` to run intake + static analysis and return the combined payload.

Tests:
- Upload a synthetic jar containing a source string that triggers at least one pattern.
- Assert `/scan` returns `static.matches` with at least one known pattern id.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Scan endpoint returns static findings and tests assert at least one detected indicator.</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- Upload -> scan returns `intake` and `static` objects
</verification>

<success_criteria>
- Phase 2 ends with deterministic static results for a jar
</success_criteria>

<output>
After completion, create `.planning/phases/02-static-analysis/02-04-SUMMARY.md`
</output>
