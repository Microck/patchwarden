---
phase: 02-static-analysis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mod_sentinel/models/static.py
  - src/mod_sentinel/analysis/patterns.py
  - src/mod_sentinel/analysis/static_scan.py
  - tests/test_patterns.py
autonomous: true

must_haves:
  truths:
    - "Static scan detects suspicious code patterns from decompiled text"
    - "Catalog includes 10+ patterns across multiple categories"
  artifacts:
    - path: "src/mod_sentinel/analysis/patterns.py"
      provides: "Suspicious pattern catalog"
    - path: "src/mod_sentinel/analysis/static_scan.py"
      provides: "Pattern matching engine"
  key_links:
    - from: "src/mod_sentinel/analysis/static_scan.py"
      to: "src/mod_sentinel/analysis/patterns.py"
      via: "catalog iteration"
      pattern: "for .* in .*PATTERNS"
---

<objective>
Define the suspicious pattern catalog and implement deterministic pattern matching over decompiled text.

Purpose: Provide the Static Agent with concrete indicators (obfuscation, network calls, file writes, reflection, process execution).
Output: Pattern catalog + matcher + unit tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define suspicious pattern catalog (10+ rules)</name>
  <files>src/mod_sentinel/analysis/patterns.py</files>
  <action>
Create a catalog of suspicious patterns with at least:
- 3 obfuscation indicators (e.g., long base64 strings, high-entropy identifiers, string deobfuscation loops)
- 3 network indicators (e.g., java.net.URLConnection, OkHttp, raw sockets)
- 2 file I/O indicators (FileOutputStream, Files.write)
- 1 reflection indicator (Class.forName/Method.invoke)
- 1 process execution indicator (Runtime.exec/ProcessBuilder)

Each pattern should have:
- stable `id` (e.g., `NET-URLCONNECTION`)
- `title`, `category`, `severity` (low/med/high)
- regex (compiled) and a short `rationale` string

Keep patterns benign: they are detection rules, not malware payloads.
  </action>
  <verify>python3 -c "from mod_sentinel.analysis.patterns import PATTERNS; assert len(PATTERNS) >= 10"</verify>
  <done>Catalog contains 10+ patterns with stable IDs and severities.</done>
</task>

<task type="auto">
  <name>Task 2: Pattern matcher + result model + tests</name>
  <files>
src/mod_sentinel/models/static.py
src/mod_sentinel/analysis/static_scan.py
tests/test_patterns.py
  </files>
  <action>
Implement a matcher that takes a list of `(path, text)` sources and returns `StaticFindings`:
- per-file matches
- rolled-up counts by category + severity
- list of matched pattern IDs with evidence snippets (small excerpt around match)

Write tests using synthetic source strings (not real malware) that contain:
- a fake URLConnection usage
- a Runtime.exec string
- a base64-ish long literal
and assert the expected pattern IDs are returned.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Matcher returns deterministic findings and tests cover multiple categories.</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- Catalog has 10+ patterns and matcher produces evidence excerpts
</verification>

<success_criteria>
- Static scanning can identify suspicious indicators from plain text inputs
</success_criteria>

<output>
After completion, create `.planning/phases/02-static-analysis/02-02-SUMMARY.md`
</output>
