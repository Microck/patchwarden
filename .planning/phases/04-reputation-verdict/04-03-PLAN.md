---
phase: 04-reputation-verdict
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/mod_sentinel/pipeline/scan_pipeline.py
  - src/mod_sentinel/store/__init__.py
  - src/mod_sentinel/store/scans.py
  - src/mod_sentinel/models/scan.py
  - src/mod_sentinel/api/routes/scan.py
  - src/mod_sentinel/api/routes/scans.py
  - src/mod_sentinel/api/main.py
  - tests/test_scan_full.py
autonomous: true

must_haves:
  truths:
    - "Full scan produces intake + static + behavior + (optional) reputation + verdict"
    - "Scan results are retrievable by scan_id"
  artifacts:
    - path: "src/mod_sentinel/pipeline/scan_pipeline.py"
      provides: "Orchestrated analysis pipeline"
    - path: "src/mod_sentinel/store/scans.py"
      provides: "Scan result persistence"
  key_links:
    - from: "src/mod_sentinel/api/routes/scans.py"
      to: "src/mod_sentinel/store/scans.py"
      via: "load by id"
      pattern: "get_scan"
---

<objective>
Wire all agents into a single scan pipeline, persist results, and expose a read endpoint for UI/demo.

Purpose: Make the product end-to-end usable for the upcoming web UI and demo.
Output: Pipeline orchestrator + scan store + GET /scans/{scan_id} + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-reputation-verdict/04-01-SUMMARY.md
@.planning/phases/04-reputation-verdict/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build scan pipeline + persistence store</name>
  <files>
src/mod_sentinel/pipeline/scan_pipeline.py
src/mod_sentinel/store/__init__.py
src/mod_sentinel/store/scans.py
src/mod_sentinel/models/scan.py
  </files>
  <action>
Create a `scan_pipeline` function/class that orchestrates:
- intake
- static
- behavior
- reputation (only if author metadata provided)
- verdict

Create a `ScanStore` that persists scan results:
- in-memory for runtime
- optional JSON file persistence under `.local-data/scans/` (default on)

Return a `scan_id` (uuid) for every scan.
  </action>
  <verify>python3 -c "from mod_sentinel.pipeline.scan_pipeline import run_scan; print('ok')"</verify>
  <done>Pipeline can be invoked programmatically and returns a scan_id + ScanResult.</done>
</task>

<task type="auto">
  <name>Task 2: Update /scan to return scan_id and add GET /scans/{scan_id}</name>
  <files>
src/mod_sentinel/api/routes/scan.py
src/mod_sentinel/api/routes/scans.py
src/mod_sentinel/api/main.py
tests/test_scan_full.py
  </files>
  <action>
Update `POST /scan` to:
- run pipeline
- store results
- return `{scan_id, result}` (or `{scan_id}` plus a retrieval URL)

Add `GET /scans/{scan_id}` returning the stored ScanResult.

Tests:
- Upload -> scan -> get scan by id and assert verdict present.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Scan results persist and are retrievable via API.</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- Manual: upload -> scan returns scan_id; GET by scan_id returns verdict
</verification>

<success_criteria>
- Full end-to-end scan pipeline is accessible via stable API endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/04-reputation-verdict/04-03-SUMMARY.md`
</output>
